# Project Structure

## Repository Organization

HashHive follows a Turborepo + Bun workspaces monorepo structure with separate backend and frontend applications sharing common schemas.

```text
/
├── packages/
│   ├── backend/          # Bun + Hono API
│   │   ├── src/
│   │   │   ├── routes/       # Hono route handlers by domain
│   │   │   │   ├── agent/    # Agent API routes (/api/v1/agent/*)
│   │   │   │   └── dashboard/# Dashboard API routes (/api/v1/dashboard/*)
│   │   │   ├── db/           # Drizzle client setup, connection config
│   │   │   ├── middleware/   # Hono middleware (auth, logging, etc.)
│   │   │   └── services/     # Business logic (optional, only when needed)
│   │   ├── tests/
│   │   │   ├── unit/         # Service and utility tests
│   │   │   └── integration/  # API tests
│   │   ├── drizzle.config.ts # Drizzle Kit configuration
│   │   └── package.json
│   │
│   ├── frontend/         # React 19 + Vite UI
│   │   ├── src/
│   │   │   ├── components/   # React components
│   │   │   │   ├── ui/       # shadcn/ui base components
│   │   │   │   └── features/ # Feature-specific components
│   │   │   ├── pages/        # Route-level page components
│   │   │   ├── lib/          # Utilities and API client config
│   │   │   ├── hooks/        # Custom React hooks (TanStack Query wrappers)
│   │   │   └── stores/       # Zustand stores for UI state
│   │   └── package.json
│   │
│   ├── shared/           # Shared Drizzle schema, Zod schemas, and types
│   │   ├── src/
│   │   │   ├── db/
│   │   │   │   ├── schema.ts     # Drizzle table definitions (source of truth)
│   │   │   │   └── migrations/   # Generated by drizzle-kit
│   │   │   ├── schemas/      # Zod schemas (drizzle-zod + custom)
│   │   │   └── types/        # Inferred types (z.infer exports)
│   │   └── package.json
│   │
│   └── openapi/          # API specifications
│       └── agent-api.yaml    # Agent API OpenAPI spec
│
├── docs/                 # Documentation
│   ├── MERN_proposal.md
│   └── v2_rewrite_implementation_plan/
│
├── turbo.json            # Turborepo configuration
└── package.json          # Root package.json (Bun workspace)
```

## Backend Architecture

**No premature abstraction**: Hono route handlers can call Drizzle queries directly. Service layers are optional and only introduced when handlers become complex.

### Route Organization

- **Agent API routes** (`src/routes/agent/`): Batch operations for Go-based agents
  - Pre-shared token authentication
  - Bulk inserts for hash submissions (use Drizzle or raw Bun.SQL for performance)
  - Endpoints: sessions, heartbeat, tasks/next, tasks/:id/report
- **Dashboard API routes** (`src/routes/dashboard/`): Standard REST API for React frontend
  - Session-based authentication
  - Low traffic (1-3 concurrent users)
  - Standard CRUD operations

### Optional Service Modules

Only create service modules when route handlers become complex:

- **AuthService**: Login, logout, token/session management
- **AgentService**: Registration, heartbeat, capability detection
- **CampaignService**: Campaign lifecycle, attack orchestration
- **TaskDistributionService**: Keyspace partitioning, task queueing
- **ResourceService**: File uploads, hash list parsing
- **HashAnalysisService**: Hash type identification, hashcat mode mapping
- **EventService**: WebSocket broadcasting

## PostgreSQL Tables

- **users**: User accounts with authentication and audit fields
- **projects**: Project definitions with settings
- **project_users**: Many-to-many user-project associations with roles (text array: admin, power-user, user)
- **operating_systems**: Static catalog for agent capabilities
- **agents**: Agent registration, status, capabilities, hardware profiles
- **agent_errors**: Error logs with severity and context
- **campaigns**: Campaign definitions with hash lists and metadata
- **attacks**: Attack configurations with mode, resources, and dependencies
- **tasks**: Task assignments with progress and results
- **hash_lists**: Hash list metadata with file references
- **hash_items**: Individual hashes with crack status
- **hash_types**: Hashcat mode catalog
- **word_lists**, **rule_lists**, **mask_lists**: Resource metadata

## API Route Structure

### Agent API (`/api/v1/agent/*`)

- **Purpose**: Batch operations for Go-based hashcat agents
- **Authentication**: Pre-shared tokens (sent on every request, no JWT exchange)
- **Contract**: Defined by OpenAPI specification in `openapi/agent-api.yaml`
- **Key endpoints**:
  - `POST /agent/sessions` - Agent authentication
  - `POST /agent/heartbeat` - Status updates
  - `POST /agent/tasks/next` - Request work
  - `POST /agent/tasks/:id/report` - Submit results (bulk inserts)

### Dashboard API (`/api/v1/dashboard/*`)

- **Purpose**: Standard REST API for React frontend (1-3 concurrent users)
- **Authentication**: JWT + HttpOnly session cookies
- **Pattern**: Standard REST CRUD operations (no tRPC)
- **Key endpoints**: Projects, agents, campaigns, attacks, tasks, resources, hash analysis

## Frontend Structure

- **Vite + React 19**: No Next.js, no server components
- **TanStack Query**: All server state (API data fetching, caching, background refetch)
- **Zustand**: Client-side UI state (selected agents, filters, dashboard layout)
- **shadcn/ui**: Components copied into project via CLI (no external component library)
- **React Hook Form + Zod**: Form handling with shared Zod schemas from `shared/` package
- **WebSocket**: Real-time updates for dashboard with polling fallback (agent heartbeats, crack results)

## Testing Organization

- **bun:test for all tests** (Bun's built-in test runner)
- **Backend Unit Tests**: Service logic, utilities, validation schemas
- **Backend Integration Tests**: API endpoints with test database
- **Frontend Component Tests**: Testing Library for React components
- **E2E Tests**: Playwright for complete user workflows

## Configuration

- **Environment variables**: `.env` files
- **Centralized config**: Single config module with Zod validation
- **12-factor principles**: All config via environment variables
- **Development**: `turbo dev` starts everything (PostgreSQL runs separately)

## Naming Conventions

- **Files**: kebab-case (e.g., `agent-service.ts`)
- **Components**: PascalCase (e.g., `AgentList.tsx`)
- **Functions**: camelCase (e.g., `createCampaign`)
- **Types/Interfaces**: PascalCase (e.g., `AgentStatus`)
- **Constants**: UPPER_SNAKE_CASE (e.g., `MAX_RETRY_ATTEMPTS`)
- **PostgreSQL Tables**: snake_case (e.g., `hash_lists`)
