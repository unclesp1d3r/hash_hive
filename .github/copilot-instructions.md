# HashHive AI Coding Instructions

HashHive is a TypeScript reimplementation of CipherSwarm, a distributed password cracking management system orchestrating hashcat across multiple agents.

## Architecture Overview

**Monorepo with Bun workspaces + Turborepo:**

- `packages/backend/` - Bun + Hono API with Drizzle ORM
- `packages/frontend/` - React 19 + Vite SPA with shadcn/ui, TanStack Query
- `packages/shared/` - Drizzle schema, Zod schemas, inferred TypeScript types
- `packages/openapi/` - Agent API OpenAPI specification

**Schema flow (single source of truth):** Drizzle tables → drizzle-zod → Zod schemas → `z.infer` types. One direction, no duplication.

**Route handlers call Drizzle directly** — service layers only when handlers become complex.

**Key services** (see `.kiro/specs/mern-migration/design.md`):

- `AuthService` - Login/logout, JWT/session management
- `AgentService` - Registration, heartbeat, capability detection
- `CampaignService` - Campaign lifecycle, DAG validation, attack configuration
- `TaskDistributionService` - Keyspace partitioning, task generation, assignment
- `ResourceService` - File uploads to MinIO, hash list parsing coordination
- `HashAnalysisService` - Hash-type identification, hashcat mode mapping
- `EventService` - WebSocket broadcasting for real-time dashboard updates

## Critical Design Documents

**Always consult before major changes:**

- `.kiro/steering/` - Product overview, tech stack, structure (source of truth)
- `.kiro/specs/mern-migration/` - Requirements, detailed design, task breakdown
- `AGENTS.md` - AI agent guidance (extended context)
- `packages/openapi/agent-api.yaml` - Agent API contract (single source of truth)

## Development Workflow

> Before committing any changes, always run `just ci-check` and ensure all checks and tests pass.

```bash
# Quick start
bun install                       # Install all workspace deps
docker compose up -d              # Start PostgreSQL, Redis, MinIO
bun dev                           # Start backend + frontend

# Or use just commands
just setup                        # Complete first-time setup
just dev                          # Start all services
just test                         # Run all tests
just lint                         # Lint all code
just ci-check                     # Full CI: lint + format + type-check + build + test

# Individual packages
bun --filter backend dev          # Backend only
bun --filter frontend dev         # Frontend only
bun --filter backend test         # Backend tests
```

## Configuration & Environment

- **Centralized config:** `packages/backend/src/config/env.ts` with Zod validation
- **Environment files:** `packages/backend/.env` (copy from `.env.example`)
- **12-factor principles:** All config via env vars, fails fast on validation errors
- **Strict TypeScript:** Maximum strictness via `tsconfig.base.json`

## Code Patterns

### Formatting & Linting

- **Biome** for linting and formatting (not ESLint, not Prettier)
- Run `just format` or `bun run format` to format all files
- pre-commit hooks run Biome checks and type checking

### Error Handling

- Use `HTTPException` from `hono/http-exception` for HTTP errors
- The `app.onError()` handler must check `instanceof HTTPException` before generic 500
- Structured error responses with machine-readable codes

### Validation

- Zod schemas for request/response validation (via `@hono/zod-validator`)
- Schema flow: Drizzle → drizzle-zod → Zod → TypeScript types
- Define schemas in `packages/shared/` for cross-package reuse

### Testing Strategy

- **bun:test** for all tests (not Jest, not Vitest)
- **Backend:** Integration tests with test database and mocked services
- **Frontend:** Testing Library for components, Playwright for E2E
- **Coverage target:** 80%+ for critical paths

### API Design

- **Agent API (`/api/v1/agent/*`):** Pre-shared token auth, defined by OpenAPI spec
- **Dashboard API (`/api/v1/dashboard/*`):** JWT + HttpOnly cookie auth, standard CRUD
- **Versioning:** `x-agent-api-version` header for Agent API

## Database (PostgreSQL + Drizzle ORM)

- **Tables:** snake_case (e.g., `hash_lists`, `project_users`)
- **Schema:** Defined in `packages/shared/src/db/schema.ts`
- **Migrations:** Generated by `drizzle-kit` (`just db-generate`, `just db-migrate`)
- **No destructive updates:** Use explicit status fields, preserve audit trails
- **Indexes:** Add for common query patterns

## Infrastructure Dependencies

```yaml
# docker-compose.yml provides:
PostgreSQL: localhost:5432        # Primary datastore
Redis: localhost:6379             # BullMQ queues + caching
MinIO: localhost:9000/9001        # S3-compatible storage (minioadmin/minioadmin)
```

## Naming Conventions

- Files: `kebab-case.ts`
- Components: `PascalCase.tsx`
- Functions: `camelCase`
- Types/Interfaces: `PascalCase`
- Constants: `UPPER_SNAKE_CASE`
- Database tables: `snake_case`

## Common Pitfalls

- **`exactOptionalPropertyTypes`:** Use spread `...(val ? {k: val} : {})` not `k: val ?? undefined`
- **`noUncheckedIndexedAccess`:** All `arr[i]` returns `T | undefined` — guard with null check
- **`noPropertyAccessFromIndexSignature`:** Use `obj['key']` bracket notation for index signatures
- **Biome `useLiteralKeys: "off"`:** Must stay off — conflicts with TS setting above
- **Don't skip Zod validation** — validate all external input
- **Don't commit secrets** — use .env files (gitignored)
- **Agent API changes require OpenAPI spec updates** — keep contract in sync
- **Read `.kiro/specs/mern-migration/design.md` before implementing services**

## Type Safety

- Shared types in `packages/shared/src/types/` for backend/frontend consistency
- Drizzle schema exports select/insert types via drizzle-zod
- OpenAPI spec defines Agent API contract types
- Zod schemas provide runtime validation + static types
