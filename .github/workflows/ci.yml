# NX-Powered CI Workflow
#
# This workflow uses NX for intelligent task orchestration with:
# - Affected detection: Only runs tasks for projects that changed
# - Conditional execution: Skips Docker pulls and integration tests when backend is unaffected
# - Caching: Leverages NX cache and GitHub Actions cache for faster runs
# - Parallelism: Runs tasks in parallel (configurable via --parallel flag)
#
# Strategy:
# - For PRs: Uses affected detection with PR base SHA to run only changed projects
# - For pushes to main: Runs all targets to ensure full coverage
# - Conditional Docker pulls: Only when backend is affected (saves ~30-60s)
# - Conditional tests: Integration tests only when backend affected, E2E only when frontend affected
#
# Example scenarios:
# - Frontend-only PR: Runs frontend lint/type-check/test/e2e, skips backend tests and Docker pulls
# - Backend-only PR: Runs backend lint/type-check/test/integration, pulls Docker images
# - Shared-only PR: Runs all projects (due to implicit dependencies)
# - Docs-only PR: Runs only format:check (docs not tracked by NX)
#
# See docs/NX_SETUP.md for detailed documentation on CI/CD integration.

name: CI
'on':
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
    inputs:
      base_sha:
        description: 'Base SHA for affected detection (defaults to origin/main)'
        required: false
        type: string
      force_run_all:
        description: 'Force run all targets regardless of affected detection'
        required: false
        type: boolean
        default: false
jobs:
  ci-check:
    runs-on: ubuntu-latest
    env:
      # Testcontainers configuration for GitHub Actions
      # Ryuk is a container that cleans up resources; enable it for proper cleanup
      TESTCONTAINERS_RYUK_DISABLED: false
      # Use the local Docker daemon
      DOCKER_HOST: unix:///var/run/docker.sock

      # Auth.js required environment variables for tests
      AUTH_SECRET: test-secret-key-minimum-32-characters-long-for-ci
      AUTH_URL: http://localhost:3001
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Full history needed for accurate affected detection

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          # Cache npm dependencies based on package-lock.json (compatible with npm ci)
          cache: npm

      - name: Install just
        uses: extractions/setup-just@v1

      # Use npm ci for reproducible, lockfile-respecting installs in CI
      # npm ci removes node_modules before install and does not modify package-lock.json
      - run: npm ci

      - name: Verify Docker is available for Testcontainers
        run: |
          docker --version
          docker info
          echo "Docker socket permissions:"
          ls -la /var/run/docker.sock

      - name: Pre-pull Docker images for Testcontainers
        env:
          DOCKER_BUILDKIT: 1
        run: |
          echo "Pulling Docker images used by integration tests..."
          docker pull mongo:7 &
          docker pull redis:7-alpine &
          docker pull minio/minio:latest &
          wait
          echo "All images pulled successfully"

      # Run CI checks using NX affected detection for PRs
      # For PRs: Only runs targets for affected projects
      # For pushes: Runs all targets to ensure full coverage
      - uses: mansagroup/nrwl-nx-action@v3
        with:
          targets: lint,type-check,test,test:integration,test:coverage,test:e2e
          parallel: 5

      # Upload coverage only if tests ran and coverage directory exists
      # Use if: always() to ensure upload even if tests fail
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: backend/coverage/**/*.lcov
          fail_ci_if_error: false
